# Configuration des routes WAN ({{WAN_DOMAIN}})
# Règles de sécurité WAN:
# - Frontend-service: BLOQUÉ en WAN (ni HTTP ni HTTPS)
# - /api/admin/inject: UNIQUEMENT en HTTPS avec authentification
# - Autres API (/api/serverinfos, /api/mystatus, /api/myactions, /api/done): BLOQUÉES (ni HTTP ni HTTPS)
# Le domaine est remplacé par install.sh depuis /home/essensys/domain.txt

http:
  middlewares:
    # Middleware de redirection HTTP vers HTTPS pour /api/admin/inject
    redirect-api-inject-to-https:
      redirectScheme:
        scheme: https
        permanent: true
    
    # Middleware d'authentification basique pour /api/admin/inject
    auth-api-inject-wan:
      basicAuth:
        usersFile: /etc/traefik/users.htpasswd

  routers:
    # Redirection HTTP vers HTTPS pour /api/admin/inject
    api-inject-wan-redirect:
      rule: "Host(`{{WAN_DOMAIN}}`) && PathPrefix(`/api/admin/inject`)"
      entryPoints:
        - web
      service: backend-service
      middlewares:
        - redirect-api-inject-to-https
      priority: 20
    
    # /api/admin/inject UNIQUEMENT en HTTPS avec authentification
    api-inject-wan:
      rule: "Host(`{{WAN_DOMAIN}}`) && PathPrefix(`/api/admin/inject`)"
      entryPoints:
        - websecure
      service: backend-service
      middlewares:
        - auth-api-inject-wan
      tls:
        certResolver: letsencrypt
      priority: 25
    
    # Blocage de toutes les autres routes WAN (frontend et autres API)
    # Ces routes retournent 403 Forbidden
    block-all-wan:
      rule: "Host(`{{WAN_DOMAIN}}`)"
      entryPoints:
        - web
        - websecure
      service: block-service
      tls:
        certResolver: letsencrypt
      priority: 5

  services:
    # Service backend (proxy vers backend Go sur port 7070)
    backend-service:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:7070"
        passHostHeader: true
    
    # Service de blocage (retourne 403 Forbidden)
    block-service:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:8082"
        passHostHeader: true

