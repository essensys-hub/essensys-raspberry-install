# Configuration des routes WAN ({{WAN_DOMAIN}})
# Traefik gère uniquement le frontend WAN avec authentification
# Les API sont gérées par Nginx directement (port 80) pour compatibilité client legacy
# Le domaine est remplacé par install-traefik.sh depuis /home/essensys/domain.txt

http:
  middlewares:
    # Middleware de redirection HTTP vers HTTPS
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true
    
    # Middleware d'authentification basique pour le frontend WAN
    auth-frontend-wan:
      basicAuth:
        usersFile: /etc/traefik/users.htpasswd

  routers:
    # Redirection HTTP vers HTTPS pour le WAN
    # Le middleware redirect-to-https fait la redirection avant d'atteindre le service
    frontend-wan-redirect:
      rule: "Host(`{{WAN_DOMAIN}}`)"
      entryPoints:
        - web
      service: frontend-service
      middlewares:
        - redirect-to-https
      priority: 5
    
    # Frontend WAN avec authentification (HTTPS)
    frontend-wan:
      rule: "Host(`{{WAN_DOMAIN}}`)"
      entryPoints:
        - websecure
      service: frontend-service
      middlewares:
        - auth-frontend-wan
      tls:
        certResolver: letsencrypt
      priority: 10

  services:
    # Service frontend (proxy vers nginx qui sert les fichiers statiques)
    # Nginx écoute sur port 9090 en interne pour servir le frontend
    frontend-service:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:9090"
        passHostHeader: true

